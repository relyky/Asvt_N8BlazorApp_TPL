<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±ºç­–æ¨¹ç·¨è¼¯å™¨ - Decision Tree Editor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #f5f5f5;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* å·¦å´ Tree View */
        .tree-panel {
            flex: 1;
            background: white;
            border-right: 2px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        .tree-header {
            padding: 20px;
            background: #2c3e50;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tree-header h2 {
            font-size: 20px;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .tree-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* æ¨¹ç‹€çµæ§‹æ¨£å¼ */
        .tree-node {
            margin: 5px 0;
            user-select: none;
        }

        .node-content {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            position: relative; /* æ”¯æ´ ::before å’Œ ::after å®šä½ */
        }

        .node-content:hover {
            background: #ecf0f1;
        }

        .node-content.selected {
            background: #d5e8f7;
            border-color: #3498db;
        }

        .node-content.drag-over {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        /* æ‹–æ‹‰ä½ç½®æŒ‡ç¤ºå™¨ - ä¸Šæ–¹æ’å…¥ï¼ˆç¶ è‰²ç·šï¼‰ */
        .node-content.drop-above::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: -2px;
            height: 3px;
            background: #27ae60;
            box-shadow: 0 0 6px rgba(39, 174, 96, 0.6);
            z-index: 100;
        }

        /* æ‹–æ‹‰ä½ç½®æŒ‡ç¤ºå™¨ - ä¸‹æ–¹æ’å…¥ï¼ˆè—è‰²ç·šï¼‰ */
        .node-content.drop-below::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: -2px;
            height: 3px;
            background: #3498db;
            box-shadow: 0 0 6px rgba(52, 152, 219, 0.6);
            z-index: 100;
        }

        .node-toggle {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #7f8c8d;
        }

        .node-icon {
            width: 24px;
            height: 24px;
            margin-right: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 14px;
        }

        .node-icon.if {
            background: #3498db;
            color: white;
        }

        .node-icon.else {
            background: #e67e22;
            color: white;
        }

        .node-icon.assignment {
            background: #27ae60;
            color: white;
        }

        .node-icon.none {
            background: #95a5a6;
            color: white;
        }

        .node-label {
            flex: 1;
            font-size: 14px;
        }

        .node-type-badge {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }

        .badge-if {
            background: #3498db;
            color: white;
        }

        .badge-else {
            background: #e67e22;
            color: white;
        }

        .badge-assignment {
            background: #27ae60;
            color: white;
        }

        .badge-none {
            background: #95a5a6;
            color: white;
        }

        .badge-error {
            background: #e74c3c;
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .node-children {
            margin-left: 30px;
            border-left: 2px dotted #bdc3c7;
            padding-left: 10px;
        }

        .node-children.collapsed {
            display: none;
        }

        /* å³å´ç·¨è¼¯å€ */
        .edit-panel {
            width: 400px;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .edit-header {
            padding: 20px;
            background: #34495e;
            color: white;
        }

        .edit-header h2 {
            font-size: 20px;
        }

        .edit-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Consolas', 'Courier New', monospace;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .placeholder {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }

        /* è¼¸å‡ºå€åŸŸ */
        .output-section {
            margin-top: 20px;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 4px;
        }

        .output-section h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .output-section pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        /* é©—è­‰è¨Šæ¯ */
        .validation-message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-size: 13px;
        }

        .validation-message.error {
            background: #fadbd8;
            color: #c0392b;
            border: 1px solid #e74c3c;
        }

        .validation-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #27ae60;
        }

        .validation-message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }

        /* æ‹–æ‹‰æç¤º */
        .drag-hint {
            position: fixed;
            background: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }

        /* æ»¾å‹•æ¢æ¨£å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* æŒ‰éˆ•çµ„ */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button-group .btn {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦å´ Tree View -->
        <div class="tree-panel">
            <div class="tree-header">
                <h2>ğŸ“Š æ±ºç­–æ¨¹çµæ§‹</h2>
                <div class="toolbar">
                    <button class="btn btn-primary" onclick="addRootNode()">â• æ–°å¢æ ¹ç¯€é»</button>
                    <button class="btn btn-success" onclick="validateTree()">âœ“ é©—è­‰çµæ§‹</button>
                    <button class="btn btn-primary" onclick="exportToText()">ğŸ“„ åŒ¯å‡ºè¦å‰‡</button>
                    <button class="btn btn-primary" onclick="exportToJSON()">ğŸ’¾ åŒ¯å‡º JSON</button>
                    <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">ğŸ“‚ åŒ¯å…¥ JSON</button>
                    <button class="btn btn-danger" onclick="clearTree()">ğŸ—‘ï¸ æ¸…ç©º</button>
                </div>
            </div>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importFromJSON(event)">
            <div class="tree-content" id="treeContent">
                <!-- æ¨¹ç‹€çµæ§‹æœƒå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
            </div>
        </div>

        <!-- å³å´ç·¨è¼¯å€ -->
        <div class="edit-panel">
            <div class="edit-header">
                <h2>âœï¸ ç¯€é»ç·¨è¼¯å™¨</h2>
            </div>
            <div class="edit-content" id="editContent">
                <div class="placeholder">
                    <p>è«‹å¾å·¦å´é¸æ“‡ä¸€å€‹ç¯€é»é€²è¡Œç·¨è¼¯</p>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‹–æ‹‰æç¤º -->
    <div class="drag-hint" id="dragHint"></div>

    <script>
        // ==================== è³‡æ–™æ¨¡å‹ ====================
        
        class TreeNode {
            constructor(type = 'None', id = null) {
                this.id = id || this.generateId();
                this.type = type; // 'IfCondition', 'ElseBranch', 'Assignment', 'None'
                this.condition = '';
                this.assignment = '';
                this.children = [];
                this.collapsed = false;
            }

            generateId() {
                return 'node_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            addChild(node) {
                this.children.push(node);
            }

            removeChild(nodeId) {
                this.children = this.children.filter(child => child.id !== nodeId);
            }

            toJSON() {
                return {
                    id: this.id,
                    type: this.type,
                    condition: this.condition,
                    assignment: this.assignment,
                    children: this.children.map(child => child.toJSON())
                };
            }

            static fromJSON(data) {
                const node = new TreeNode(data.type, data.id);
                node.condition = data.condition || '';
                node.assignment = data.assignment || '';
                node.children = (data.children || []).map(child => TreeNode.fromJSON(child));
                return node;
            }
        }

        // ==================== å…¨åŸŸç‹€æ…‹ ====================
        
        let treeData = {
            root: new TreeNode('Root', 'root'),
            selectedNode: null
        };

        let draggedNode = null;
        let draggedNodeParent = null;

        // ==================== åˆå§‹åŒ– ====================
        
        function init() {
            // è¼‰å…¥ç¯„ä¾‹è³‡æ–™ï¼ˆå¯é¸ï¼‰
            loadSampleData();
            renderTree();
        }

        function loadSampleData() {
            const root = treeData.root;
            
            // ç¯„ä¾‹ä¸€çš„çµæ§‹
            const if1 = new TreeNode('IfCondition');
            if1.condition = 'A = 3';
            const assign1 = new TreeNode('Assignment');
            assign1.assignment = '\'3A\'';
            if1.addChild(assign1);
            
            const if2 = new TreeNode('IfCondition');
            if2.condition = 'B = 4';
            const assign2 = new TreeNode('Assignment');
            assign2.assignment = '\'Bar\'';
            if2.addChild(assign2);
            
            const if3 = new TreeNode('IfCondition');
            if3.condition = 'A < 10';
            const assign3 = new TreeNode('Assignment');
            assign3.assignment = '\'å°‘æ•¸\'';
            if3.addChild(assign3);
            
            const else1 = new TreeNode('ElseBranch');
            const assign4 = new TreeNode('Assignment');
            assign4.assignment = '\'otherwise\'';
            else1.addChild(assign4);
            
            root.addChild(if1);
            root.addChild(if2);
            root.addChild(if3);
            root.addChild(else1);
        }

        // ==================== Tree æ¸²æŸ“ ====================
        
        function renderTree() {
            const container = document.getElementById('treeContent');
            container.innerHTML = '';
            
            if (treeData.root.children.length === 0) {
                container.innerHTML = '<div class="placeholder"><p>å°šç„¡ç¯€é»ï¼Œè«‹é»æ“Šã€Œæ–°å¢æ ¹ç¯€é»ã€é–‹å§‹å»ºç«‹æ±ºç­–æ¨¹</p></div>';
                return;
            }
            
            treeData.root.children.forEach(child => {
                container.appendChild(renderNode(child, treeData.root));
            });
        }

        function renderNode(node, parent) {
            const nodeDiv = document.createElement('div');
            nodeDiv.className = 'tree-node';
            nodeDiv.setAttribute('data-node-id', node.id);
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'node-content';
            contentDiv.draggable = true;
            
            if (treeData.selectedNode && treeData.selectedNode.id === node.id) {
                contentDiv.classList.add('selected');
            }
            
            // å±•é–‹/æ”¶åˆæŒ‰éˆ•
            const toggleBtn = document.createElement('span');
            toggleBtn.className = 'node-toggle';
            if (node.children.length > 0) {
                toggleBtn.textContent = node.collapsed ? 'â–¶' : 'â–¼';
                toggleBtn.onclick = (e) => {
                    e.stopPropagation();
                    toggleNode(node.id);
                };
            }
            contentDiv.appendChild(toggleBtn);
            
            // ç¯€é»åœ–ç¤º
            const icon = document.createElement('span');
            icon.className = 'node-icon ' + getNodeClass(node.type);
            icon.textContent = getNodeIcon(node.type);
            contentDiv.appendChild(icon);
            
            // ç¯€é»æ¨™ç±¤
            const label = document.createElement('span');
            label.className = 'node-label';
            label.textContent = getNodeLabel(node);
            contentDiv.appendChild(label);
            
            // é¡å‹æ¨™ç±¤
            const badge = document.createElement('span');
            badge.className = 'node-type-badge badge-' + getNodeClass(node.type);
            badge.textContent = getNodeTypeName(node.type);
            contentDiv.appendChild(badge);
            
            // å¦‚æœ Assignment æœ‰å­ç¯€é»ï¼Œé¡¯ç¤ºéŒ¯èª¤æ¨™è¨˜
            if (node.type === 'Assignment' && node.children.length > 0) {
                const errorBadge = document.createElement('span');
                errorBadge.className = 'node-type-badge badge-error';
                errorBadge.textContent = 'âš ï¸ éŒ¯èª¤';
                errorBadge.title = 'Assignment ä¸æ‡‰è©²æœ‰å­ç¯€é»';
                errorBadge.style.marginLeft = '5px';
                contentDiv.appendChild(errorBadge);
            }
            
            // äº‹ä»¶ç›£è½
            contentDiv.onclick = () => selectNode(node);
            contentDiv.ondragstart = (e) => handleDragStart(e, node, parent);
            contentDiv.ondragover = (e) => handleDragOver(e);
            contentDiv.ondrop = (e) => handleDrop(e, node);
            contentDiv.ondragenter = (e) => handleDragEnter(e);
            contentDiv.ondragleave = (e) => handleDragLeave(e);
            contentDiv.ondragend = (e) => handleDragEnd(e);
            
            nodeDiv.appendChild(contentDiv);
            
            // å­ç¯€é»
            if (node.children.length > 0) {
                const childrenDiv = document.createElement('div');
                childrenDiv.className = 'node-children' + (node.collapsed ? ' collapsed' : '');
                node.children.forEach(child => {
                    childrenDiv.appendChild(renderNode(child, node));
                });
                nodeDiv.appendChild(childrenDiv);
            }
            
            return nodeDiv;
        }

        function getNodeIcon(type) {
            const icons = {
                'IfCondition': '?',
                'ElseBranch': 'â†©',
                'Assignment': '=',
                'None': 'â—‹'
            };
            return icons[type] || 'â—‹';
        }

        function getNodeClass(type) {
            const classes = {
                'IfCondition': 'if',
                'ElseBranch': 'else',
                'Assignment': 'assignment',
                'None': 'none'
            };
            return classes[type] || 'none';
        }

        function getNodeTypeName(type) {
            const names = {
                'IfCondition': 'IF',
                'ElseBranch': 'ELSE',
                'Assignment': 'ASSIGN',
                'None': 'NONE'
            };
            return names[type] || 'NONE';
        }

        function getNodeLabel(node) {
            if (node.type === 'IfCondition') {
                return node.condition ? `IF ${node.condition}` : 'IF (æœªè¨­å®šæ¢ä»¶)';
            } else if (node.type === 'ElseBranch') {
                return 'ELSE';
            } else if (node.type === 'Assignment') {
                return node.assignment ? node.assignment : '(æœªè¨­å®šæŒ‡å®šå€¼)';
            } else if (node.type === 'Root') {
                return 'æ ¹ç¯€é»';
            } else {
                return 'NONE (æœªæŒ‡å®šé¡å‹)';
            }
        }

        // ==================== ç¯€é»æ“ä½œ ====================
        
        function toggleNode(nodeId) {
            const node = findNodeById(treeData.root, nodeId);
            if (node) {
                node.collapsed = !node.collapsed;
                renderTree();
            }
        }

        function selectNode(node) {
            treeData.selectedNode = node;
            renderTree();
            renderEditPanel(node);
        }

        function addRootNode() {
            const newNode = new TreeNode('None');
            treeData.root.addChild(newNode);
            renderTree();
            selectNode(newNode);
        }

        function clearTree() {
            if (treeData.root.children.length === 0) {
                showNotification('âš ï¸ æ¨¹å·²ç¶“æ˜¯ç©ºçš„ï¼', 'warning');
                return;
            }
            
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ•´å€‹æ±ºç­–æ¨¹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                treeData.root = new TreeNode('Root', 'root');
                treeData.selectedNode = null;
                renderTree();
                renderEditPanel(null);
                showNotification('âœ“ æ±ºç­–æ¨¹å·²æ¸…ç©ºï¼', 'success');
            }
        }

        function addChildNode(parentNode) {
            const newNode = new TreeNode('None');
            parentNode.addChild(newNode);
            renderTree();
            selectNode(newNode);
        }

        function addSiblingNode(currentNode) {
            const parent = findParentNode(treeData.root, currentNode.id);
            if (!parent) {
                alert('æ ¹ç¯€é»ç„¡æ³•æ–°å¢å…„å¼Ÿç¯€é»ï¼');
                return;
            }

            const newNode = new TreeNode('None');
            const currentIndex = parent.children.findIndex(child => child.id === currentNode.id);
            parent.children.splice(currentIndex + 1, 0, newNode);

            renderTree();
            selectNode(newNode);
        }

        function deleteNode(node, parent) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç¯€é»åŠå…¶æ‰€æœ‰å­ç¯€é»å—ï¼Ÿ')) {
                parent.removeChild(node.id);
                treeData.selectedNode = null;
                renderTree();
                renderEditPanel(null);
            }
        }

        // ==================== ç·¨è¼¯é¢æ¿ ====================
        
        function renderEditPanel(node) {
            const container = document.getElementById('editContent');
            
            if (!node) {
                container.innerHTML = '<div class="placeholder"><p>è«‹å¾å·¦å´é¸æ“‡ä¸€å€‹ç¯€é»é€²è¡Œç·¨è¼¯</p></div>';
                return;
            }
            
            const parent = findParentNode(treeData.root, node.id);
            
            // æª¢æŸ¥ Assignment ç¯€é»æ˜¯å¦æœ‰å­ç¯€é»ï¼ˆéŒ¯èª¤ç‹€æ…‹ï¼‰
            const hasAssignmentError = node.type === 'Assignment' && node.children.length > 0;
            
            container.innerHTML = `
                ${hasAssignmentError ? '<div class="validation-message error">âš ï¸ <strong>çµæ§‹éŒ¯èª¤ï¼š</strong>Assignment æ˜¯çµ‚æ­¢é»ï¼Œä¸æ‡‰è©²æœ‰å­ç¯€é»ï¼ç›®å‰æœ‰ ' + node.children.length + ' å€‹å­ç¯€é»ã€‚<br>è«‹åˆªé™¤æ‰€æœ‰å­ç¯€é»æˆ–èª¿æ•´çµæ§‹ã€‚</div>' : ''}
                
                <div class="form-group">
                    <label>ç¯€é»é¡å‹</label>
                    <select id="nodeType" onchange="updateNodeType()">
                        <option value="None" ${node.type === 'None' ? 'selected' : ''}>NONE (æœªæŒ‡å®š)</option>
                        <option value="IfCondition" ${node.type === 'IfCondition' ? 'selected' : ''}>IF (æ¢ä»¶åˆ¤æ–·)</option>
                        <option value="ElseBranch" ${node.type === 'ElseBranch' ? 'selected' : ''}>ELSE (å…¶å®ƒåˆ†æ”¯)</option>
                        <option value="Assignment" ${node.type === 'Assignment' ? 'selected' : ''}>Assignment (æŒ‡å®šæ•¸å€¼)</option>
                    </select>
                </div>
                
                <div class="form-group" id="conditionGroup" style="display: ${node.type === 'IfCondition' ? 'block' : 'none'}">
                    <label>æ¢ä»¶ (Condition)</label>
                    <input type="text" id="nodeCondition" value="${node.condition || ''}" 
                           placeholder="ä¾‹å¦‚: A = 3, B > 10" onchange="updateNodeCondition()">
                </div>
                
                <div class="form-group" id="assignmentGroup" style="display: ${node.type === 'Assignment' ? 'block' : 'none'}">
                    <label>æŒ‡å®šå€¼ (Assignment)</label>
                    <textarea id="nodeAssignment" onchange="updateNodeAssignment()" 
                              placeholder="ä¾‹å¦‚: '3A', 'Bar', result">${node.assignment || ''}</textarea>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="addChildNode(treeData.selectedNode)">â• æ–°å¢å­ç¯€é»</button>
                    ${parent ? '<button class="btn btn-primary" onclick="addSiblingNode(treeData.selectedNode)">â• æ–°å¢å…„å¼Ÿç¯€é»</button>' : ''}
                </div>
                <div class="button-group">
                    <button class="btn btn-danger" onclick="deleteNode(treeData.selectedNode, findParentNode(treeData.root, treeData.selectedNode.id))">ğŸ—‘ï¸ åˆªé™¤ç¯€é»</button>
                </div>
                
                <div class="output-section">
                    <h3>ç¯€é»è³‡è¨Š</h3>
                    <div class="form-group">
                        <select id="infoFormat" onchange="toggleInfoFormat()">
                            <option value="text">åŸºæœ¬è³‡è¨Š</option>
                            <option value="json">JSON æ ¼å¼</option>
                        </select>
                    </div>
                    <pre id="textInfo">ID: ${node.id}
é¡å‹: ${getNodeTypeName(node.type)}
å­ç¯€é»æ•¸: ${node.children.length}
${node.condition ? 'æ¢ä»¶: ' + node.condition : ''}
${node.type === 'Assignment' && node.assignment ? 'æŒ‡å®šå€¼: ' + node.assignment : ''}</pre>
                    <pre id="jsonInfo" style="display: none;">${JSON.stringify(node.toJSON(), null, 2)}</pre>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="copyNodeJSON()">ğŸ“‹ è¤‡è£½ç¯€é» JSON</button>
                </div>
            `;
        }

        function updateNodeType() {
            const type = document.getElementById('nodeType').value;
            const currentNode = treeData.selectedNode;

            currentNode.type = type;

            // æ ¹æ“šé¡å‹é¡¯ç¤º/éš±è—æ¬„ä½
            const conditionGroup = document.getElementById('conditionGroup');
            const assignmentGroup = document.getElementById('assignmentGroup');

            conditionGroup.style.display = type === 'IfCondition' ? 'block' : 'none';
            assignmentGroup.style.display = type === 'Assignment' ? 'block' : 'none';

            renderTree();
            renderEditPanel(treeData.selectedNode);
        }

        function updateNodeCondition() {
            const condition = document.getElementById('nodeCondition').value;
            treeData.selectedNode.condition = condition;
            renderTree();
        }

        function updateNodeAssignment() {
            const assignment = document.getElementById('nodeAssignment').value;
            treeData.selectedNode.assignment = assignment;
            renderTree();
        }

        function toggleInfoFormat() {
            const format = document.getElementById('infoFormat').value;
            const textInfo = document.getElementById('textInfo');
            const jsonInfo = document.getElementById('jsonInfo');
            
            if (format === 'text') {
                textInfo.style.display = 'block';
                jsonInfo.style.display = 'none';
            } else {
                textInfo.style.display = 'none';
                jsonInfo.style.display = 'block';
            }
        }

        function copyNodeJSON() {
            const node = treeData.selectedNode;
            if (!node) return;
            
            const json = JSON.stringify(node.toJSON(), null, 2);
            navigator.clipboard.writeText(json).then(() => {
                showNotification('âœ“ ç¯€é» JSON å·²è¤‡è£½ï¼', 'success');
            });
        }

        // ==================== æ‹–æ‹‰åŠŸèƒ½ ====================
        
        function handleDragStart(e, node, parent) {
            draggedNode = node;
            draggedNodeParent = parent;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
            e.target.style.opacity = '0.5';
            
            const hint = document.getElementById('dragHint');
            hint.textContent = 'æ‹–æ›³ä¸­: ' + getNodeLabel(node);
            hint.style.display = 'block';
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';

            // ä½ç½®åµæ¸¬é‚è¼¯
            const nodeContent = e.target.closest('.node-content');
            if (nodeContent) {
                const rect = nodeContent.getBoundingClientRect();
                const mouseY = e.clientY;
                const nodeMiddle = rect.top + (rect.height / 2);

                // ä¸ŠåŠéƒ¨ = aboveï¼ˆå…„å¼Ÿï¼‰ï¼Œä¸‹åŠéƒ¨ = belowï¼ˆå­ç¯€é»ï¼‰
                const dropPosition = mouseY < nodeMiddle ? 'above' : 'below';
                nodeContent.setAttribute('data-drop-position', dropPosition);

                updateDropIndicator(nodeContent, dropPosition);
            }

            const hint = document.getElementById('dragHint');
            hint.style.left = (e.pageX + 10) + 'px';
            hint.style.top = (e.pageY + 10) + 'px';

            return false;
        }

        function updateDropIndicator(nodeContent, position) {
            // ç§»é™¤èˆŠæ¨£å¼
            nodeContent.classList.remove('drop-above', 'drop-below');

            // æ·»åŠ æ–°æ¨£å¼
            if (position === 'above') {
                nodeContent.classList.add('drop-above');
            } else {
                nodeContent.classList.add('drop-below');
            }
        }

        function handleDragEnter(e) {
            e.target.closest('.node-content')?.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            const nodeContent = e.target.closest('.node-content');
            if (nodeContent) {
                nodeContent.classList.remove('drag-over', 'drop-above', 'drop-below');
                nodeContent.removeAttribute('data-drop-position');
            }
        }

        function handleDrop(e, targetNode) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const nodeContent = e.target.closest('.node-content');
            nodeContent?.classList.remove('drag-over', 'drop-above', 'drop-below');

            // åŸºæœ¬æª¢æŸ¥
            if (!draggedNode || !targetNode || draggedNode.id === targetNode.id) {
                return false;
            }

            // æª¢æŸ¥å¾ªç’°ä¾è³´
            if (isDescendant(draggedNode, targetNode)) {
                showNotification('âš ï¸ ç„¡æ³•å°‡ç¯€é»ç§»å‹•åˆ°å…¶å­ç¯€é»ä¸‹ï¼', 'error');
                return false;
            }

            // å–å¾—æ”¾ç½®ä½ç½®
            const dropPosition = nodeContent?.getAttribute('data-drop-position') || 'below';

            // æ ¹æ“šä½ç½®åŸ·è¡Œæ’å…¥
            if (dropPosition === 'above') {
                return handleDropAsSibling(draggedNode, draggedNodeParent, targetNode);
            } else {
                return handleDropAsFirstChild(draggedNode, draggedNodeParent, targetNode);
            }
        }

        function handleDragEnd(e) {
            e.target.style.opacity = '1';
            document.getElementById('dragHint').style.display = 'none';

            // æ¸…ç†æ‰€æœ‰æ‹–æ‹‰ç›¸é—œæ¨£å¼å’Œå±¬æ€§
            document.querySelectorAll('.drag-over, .drop-above, .drop-below').forEach(el => {
                el.classList.remove('drag-over', 'drop-above', 'drop-below');
                el.removeAttribute('data-drop-position');
            });
        }

        /**
         * å°‡æ‹–æ‹‰ç¯€é»æ’å…¥ç‚ºç›®æ¨™ç¯€é»çš„ä¸Šæ–¹å…„å¼Ÿç¯€é»
         */
        function handleDropAsSibling(draggedNode, draggedNodeParent, targetNode) {
            // æ‰¾åˆ°ç›®æ¨™ç¯€é»çš„çˆ¶ç¯€é»
            const targetParent = findParentNode(treeData.root, targetNode.id);

            // æ ¹å±¤ç´šç¯€é»ç„¡æ³•æ’å…¥å…„å¼Ÿ
            if (!targetParent) {
                showNotification('âš ï¸ æ ¹å±¤ç´šç¯€é»ç„¡æ³•æ’å…¥å…„å¼Ÿç¯€é»ï¼', 'warning');
                return false;
            }

            // æ‰¾åˆ°ç›®æ¨™ç¯€é»åœ¨å…¶çˆ¶ç¯€é»ä¸­çš„ç´¢å¼•
            const targetIndex = targetParent.children.findIndex(child => child.id === targetNode.id);

            // å¾åŸçˆ¶ç¯€é»ç§»é™¤
            draggedNodeParent.removeChild(draggedNode.id);

            // è™•ç†åŒçˆ¶ç¯€é»ç§»å‹•çš„ç´¢å¼•èª¿æ•´
            let insertIndex = targetIndex;
            if (draggedNodeParent.id === targetParent.id) {
                // å¦‚æœåŸæœ¬åœ¨ç›®æ¨™ä¹‹å‰ï¼Œç§»é™¤å¾Œç´¢å¼•æœƒæ¸› 1
                const originalIndex = targetParent.children.findIndex(child => child.id === draggedNode.id);
                if (originalIndex !== -1 && originalIndex < targetIndex) {
                    insertIndex = targetIndex - 1;
                }
            }

            // åœ¨ç›®æ¨™ç¯€é»ä¸Šæ–¹æ’å…¥
            targetParent.children.splice(insertIndex, 0, draggedNode);

            renderTree();
            return false;
        }

        /**
         * å°‡æ‹–æ‹‰ç¯€é»æ’å…¥ç‚ºç›®æ¨™ç¯€é»çš„ç¬¬ä¸€å€‹å­ç¯€é»
         */
        function handleDropAsFirstChild(draggedNode, draggedNodeParent, targetNode) {
            // å¾åŸçˆ¶ç¯€é»ç§»é™¤
            draggedNodeParent.removeChild(draggedNode.id);

            // æ’å…¥ç‚ºç¬¬ä¸€å€‹å­ç¯€é»
            targetNode.children.unshift(draggedNode);

            renderTree();
            return false;
        }

        function isDescendant(parent, child) {
            if (parent.id === child.id) return true;
            for (let node of parent.children) {
                if (isDescendant(node, child)) return true;
            }
            return false;
        }

        // ==================== è¼”åŠ©å‡½å¼ ====================
        
        function findNodeById(node, id) {
            if (node.id === id) return node;
            for (let child of node.children) {
                const found = findNodeById(child, id);
                if (found) return found;
            }
            return null;
        }

        function findParentNode(parent, childId) {
            for (let child of parent.children) {
                if (child.id === childId) return parent;
                const found = findParentNode(child, childId);
                if (found) return found;
            }
            return null;
        }

        // ==================== é©—è­‰åŠŸèƒ½ ====================
        
        function validateTree() {
            const errors = [];
            const warnings = [];
            
            validateNode(treeData.root, errors, warnings, []);
            
            const container = document.getElementById('editContent');
            let html = '';
            
            if (errors.length === 0 && warnings.length === 0) {
                html += '<div class="validation-message success">âœ“ æ±ºç­–æ¨¹çµæ§‹é©—è­‰é€šéï¼</div>';
            }
            
            if (errors.length > 0) {
                html += '<div class="validation-message error"><strong>âŒ ç™¼ç¾éŒ¯èª¤:</strong><ul>';
                errors.forEach(err => {
                    html += `<li>${err}</li>`;
                });
                html += '</ul></div>';
            }
            
            if (warnings.length > 0) {
                html += '<div class="validation-message warning"><strong>âš ï¸ è­¦å‘Šè¨Šæ¯:</strong><ul>';
                warnings.forEach(warn => {
                    html += `<li>${warn}</li>`;
                });
                html += '</ul></div>';
            }
            
            html += '<div class="button-group"><button class="btn btn-primary" onclick="renderEditPanel(treeData.selectedNode)">è¿”å›ç·¨è¼¯</button></div>';
            
            container.innerHTML = html;
        }

        function validateNode(node, errors, warnings, path) {
            const currentPath = [...path, getNodeLabel(node)];
            
            // æª¢æŸ¥ç¯€é»é¡å‹
            if (node.type === 'None' && node.children.length === 0 && node.id !== 'root') {
                warnings.push(`è·¯å¾‘ ${currentPath.join(' > ')}: ç¯€é»é¡å‹æœªè¨­å®š`);
            }
            
            // æª¢æŸ¥ IF æ¢ä»¶
            if (node.type === 'IfCondition') {
                if (!node.condition.trim()) {
                    errors.push(`è·¯å¾‘ ${currentPath.join(' > ')}: IF ç¯€é»ç¼ºå°‘æ¢ä»¶`);
                }
                if (node.children.length === 0) {
                    warnings.push(`è·¯å¾‘ ${currentPath.join(' > ')}: IF ç¯€é»æ²’æœ‰å­ç¯€é»ï¼ˆçµæœï¼‰`);
                }
            }
            
            // æª¢æŸ¥ ELSE åˆ†æ”¯
            if (node.type === 'ElseBranch' && node.children.length === 0) {
                warnings.push(`è·¯å¾‘ ${currentPath.join(' > ')}: ELSE ç¯€é»æ²’æœ‰å­ç¯€é»ï¼ˆçµæœï¼‰`);
            }
            
            // æª¢æŸ¥ Assignment
            if (node.type === 'Assignment') {
                if (!node.assignment.trim()) {
                    errors.push(`è·¯å¾‘ ${currentPath.join(' > ')}: Assignment ç¯€é»ç¼ºå°‘æŒ‡å®šå€¼`);
                }
                // æ–°å¢è¦å‰‡ï¼šAssignment æ˜¯çµ‚æ­¢é»ï¼Œä¸æ‡‰è©²æœ‰å­ç¯€é»
                if (node.children.length > 0) {
                    errors.push(`è·¯å¾‘ ${currentPath.join(' > ')}: Assignment æ˜¯çµæ§‹çµ‚æ­¢é»ï¼Œä¸æ‡‰è©²æœ‰å­ç¯€é»ï¼ˆç™¼ç¾ ${node.children.length} å€‹å­ç¯€é»ï¼‰`);
                }
            }
            
            // æª¢æŸ¥åŒä¸€å±¤æ˜¯å¦æœ‰å¤šå€‹ ELSE
            const elseCount = node.children.filter(child => child.type === 'ElseBranch').length;
            if (elseCount > 1) {
                errors.push(`è·¯å¾‘ ${currentPath.join(' > ')}: åŒä¸€å±¤ç´šæœ‰ ${elseCount} å€‹ ELSE ç¯€é»ï¼Œåªèƒ½æœ‰ä¸€å€‹`);
            }
            
            // æª¢æŸ¥ ELSE æ˜¯å¦åœ¨æœ€å¾Œ
            const elseIndex = node.children.findIndex(child => child.type === 'ElseBranch');
            if (elseIndex !== -1 && elseIndex !== node.children.length - 1) {
                warnings.push(`è·¯å¾‘ ${currentPath.join(' > ')}: ELSE ç¯€é»å»ºè­°æ”¾åœ¨æœ€å¾Œ`);
            }
            
            // æ–°å¢è¦å‰‡2ï¼šåŒä¸€å±¤ç´šä¸­ï¼Œå¦‚æœæœ‰ Assignment ç¯€é»ï¼Œå‰‡ä¸èƒ½æœ‰å…¶ä»–ç¯€é»
            const assignmentNodes = node.children.filter(child => child.type === 'Assignment');
            const otherNodes = node.children.filter(child => child.type !== 'Assignment');
            
            if (assignmentNodes.length > 0 && otherNodes.length > 0) {
                const otherNodeTypes = otherNodes.map(n => getNodeTypeName(n.type)).join(', ');
                errors.push(`è·¯å¾‘ ${currentPath.join(' > ')}: åŒä¸€å±¤ç´šä¸­æœ‰ Assignment ç¯€é»æ™‚ï¼Œä¸èƒ½æœ‰å…¶ä»–ç¯€é»ã€‚` +
                    `ç™¼ç¾ ${assignmentNodes.length} å€‹ Assignment å’Œ ${otherNodes.length} å€‹å…¶ä»–ç¯€é»ï¼ˆ${otherNodeTypes}ï¼‰ã€‚` +
                    `Assignment æ˜¯çµ‚æ­¢é»ï¼Œè©²å±¤ç´šæ‡‰åªæœ‰ Assignment ç¯€é»ã€‚`);
            }
            
            // æª¢æŸ¥ Assignment å¾Œé¢æ˜¯å¦é‚„æœ‰å…„å¼Ÿç¯€é»ï¼ˆæ­¤è¦å‰‡è¢«ä¸Šé¢çš„è¦å‰‡æ¶µè“‹ï¼Œä¿ç•™ä½œç‚ºé¡å¤–æª¢æŸ¥ï¼‰
            const assignmentIndex = node.children.findIndex(child => child.type === 'Assignment');
            if (assignmentIndex !== -1 && assignmentIndex < node.children.length - 1) {
                // æª¢æŸ¥ Assignment å¾Œé¢çš„ç¯€é»
                const nodesAfterAssignment = node.children.slice(assignmentIndex + 1);
                const nonAssignmentNodes = nodesAfterAssignment.filter(child => child.type !== 'Assignment');
                if (nonAssignmentNodes.length > 0) {
                    warnings.push(`è·¯å¾‘ ${currentPath.join(' > ')}: Assignment ç¯€é»å¾Œé¢é‚„æœ‰ ${nonAssignmentNodes.length} å€‹é Assignment ç¯€é»ï¼Œå»ºè­°èª¿æ•´é †åº`);
                }
            }
            
            // éè¿´æª¢æŸ¥å­ç¯€é»
            node.children.forEach(child => {
                validateNode(child, errors, warnings, currentPath);
            });
        }

        // ==================== åŒ¯å‡ºåŠŸèƒ½ ====================
        
        function exportToText() {
            const textOutput = generateTextOutput(treeData.root, 0);
            const jsonOutput = JSON.stringify(treeData.root.toJSON(), null, 2);
            
            const container = document.getElementById('editContent');
            container.innerHTML = `
                <h3>æ±ºç­–æ¨¹è¼¸å‡º</h3>
                
                <div class="form-group">
                    <label>é¸æ“‡è¼¸å‡ºæ ¼å¼</label>
                    <select id="outputFormat" onchange="toggleOutputFormat()">
                        <option value="text">æ–‡å­—è¦å‰‡ (IF/ELSE)</option>
                        <option value="json">JSON æ ¼å¼</option>
                    </select>
                </div>
                
                <div id="textOutputSection">
                    <div class="output-section">
                        <h4>æ–‡å­—è¦å‰‡è¼¸å‡º</h4>
                        <pre id="textOutput">${textOutput}</pre>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="copyTextOutput()">ğŸ“‹ è¤‡è£½æ–‡å­—è¦å‰‡</button>
                        <button class="btn btn-primary" onclick="downloadTextFile()">ğŸ’¾ ä¸‹è¼‰ TXT</button>
                    </div>
                </div>
                
                <div id="jsonOutputSection" style="display: none;">
                    <div class="output-section">
                        <h4>JSON è¼¸å‡º</h4>
                        <pre id="jsonOutput">${jsonOutput}</pre>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="copyJSONOutput()">ğŸ“‹ è¤‡è£½ JSON</button>
                        <button class="btn btn-primary" onclick="exportToJSON()">ğŸ’¾ ä¸‹è¼‰ JSON</button>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="renderEditPanel(treeData.selectedNode)">è¿”å›ç·¨è¼¯</button>
                </div>
            `;
        }

        function toggleOutputFormat() {
            const format = document.getElementById('outputFormat').value;
            const textSection = document.getElementById('textOutputSection');
            const jsonSection = document.getElementById('jsonOutputSection');
            
            if (format === 'text') {
                textSection.style.display = 'block';
                jsonSection.style.display = 'none';
            } else {
                textSection.style.display = 'none';
                jsonSection.style.display = 'block';
            }
        }

        function copyTextOutput() {
            const output = document.getElementById('textOutput').textContent;
            navigator.clipboard.writeText(output).then(() => {
                showNotification('âœ“ æ–‡å­—è¦å‰‡å·²è¤‡è£½ï¼', 'success');
            });
        }

        function copyJSONOutput() {
            const output = document.getElementById('jsonOutput').textContent;
            navigator.clipboard.writeText(output).then(() => {
                showNotification('âœ“ JSON å·²è¤‡è£½ï¼', 'success');
            });
        }

        function downloadTextFile() {
            const output = generateTextOutput(treeData.root, 0);
            const blob = new Blob([output], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            a.download = `decision-tree-${timestamp}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('âœ“ TXT æª”æ¡ˆå·²ä¸‹è¼‰ï¼', 'success');
        }

        function generateTextOutput(node, indent) {
            let output = '';
            const spaces = '  '.repeat(indent);
            
            for (let child of node.children) {
                if (child.type === 'IfCondition') {
                    output += `${spaces}IF ${child.condition}\n`;
                    if (child.children.length > 0) {
                        output += generateTextOutput(child, indent + 1);
                    }
                } else if (child.type === 'ElseBranch') {
                    output += `${spaces}ELSE\n`;
                    if (child.children.length > 0) {
                        output += generateTextOutput(child, indent + 1);
                    }
                } else if (child.type === 'Assignment') {
                    output += `${spaces}${child.assignment}\n`;
                    // Assignment æ˜¯çµ‚æ­¢é»ï¼Œä¸æ‡‰è©²æœ‰å­ç¯€é»
                    // å¦‚æœæœ‰å­ç¯€é»ï¼Œé©—è­‰æ™‚æœƒå ±éŒ¯ï¼Œé€™è£¡ä¸è¼¸å‡º
                }
            }
            
            return output;
        }

        // ==================== JSON åŒ¯å…¥/åŒ¯å‡º ====================
        
        function exportToJSON() {
            const treeJSON = treeData.root.toJSON();
            const jsonString = JSON.stringify(treeJSON, null, 2);
            
            // ä¸‹è¼‰ JSON æª”æ¡ˆ
            const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            a.download = `decision-tree-${timestamp}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            showNotification('âœ“ JSON å·²åŒ¯å‡ºï¼', 'success');
        }

        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    
                    // é©—è­‰ JSON çµæ§‹
                    if (!jsonData.id || !jsonData.type || !Array.isArray(jsonData.children)) {
                        throw new Error('JSON æ ¼å¼ä¸æ­£ç¢ºï¼šç¼ºå°‘å¿…è¦æ¬„ä½ (id, type, children)');
                    }
                    
                    // ç¢ºèªæ˜¯å¦è¦†è“‹ç¾æœ‰è³‡æ–™
                    if (treeData.root.children.length > 0) {
                        if (!confirm('åŒ¯å…¥ JSON å°‡æœƒè¦†è“‹ç¾æœ‰çš„æ±ºç­–æ¨¹ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                            event.target.value = ''; // æ¸…ç©º file input
                            return;
                        }
                    }
                    
                    // é‚„åŸæ¨¹ç‹€çµæ§‹
                    treeData.root = TreeNode.fromJSON(jsonData);
                    treeData.selectedNode = null;
                    
                    // é‡æ–°æ¸²æŸ“
                    renderTree();
                    renderEditPanel(null);
                    
                    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯ä¸¦æç¤ºé©—è­‰
                    showNotification('âœ“ JSON åŒ¯å…¥æˆåŠŸï¼å»ºè­°åŸ·è¡Œã€Œé©—è­‰çµæ§‹ã€æª¢æŸ¥ã€‚', 'success');
                    
                    // è©¢å•æ˜¯å¦ç«‹å³é©—è­‰
                    setTimeout(() => {
                        if (confirm('æ˜¯å¦ç«‹å³é©—è­‰çµæ§‹ï¼Ÿ\nå¯ä»¥æª¢æŸ¥æ˜¯å¦æœ‰ Assignment çµ‚æ­¢é»éŒ¯èª¤ç­‰å•é¡Œã€‚')) {
                            validateTree();
                        }
                    }, 1000);
                    
                } catch (error) {
                    alert('åŒ¯å…¥å¤±æ•—ï¼š' + error.message);
                    console.error('Import error:', error);
                }
                
                // æ¸…ç©º file input ä»¥ä¾¿ä¸‹æ¬¡å¯ä»¥é¸æ“‡åŒä¸€å€‹æª”æ¡ˆ
                event.target.value = '';
            };
            
            reader.onerror = function() {
                alert('è®€å–æª”æ¡ˆå¤±æ•—ï¼');
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }

        function showNotification(message, type = 'info') {
            // å»ºç«‹é€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `validation-message ${type}`;
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.style.minWidth = '200px';
            notification.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
            
            document.body.appendChild(notification);
            
            // 3 ç§’å¾Œè‡ªå‹•ç§»é™¤
            setTimeout(() => {
                notification.style.transition = 'opacity 0.5s';
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 3000);
        }

        // ==================== å•Ÿå‹• ====================
        
        window.onload = init;
    </script>
</body>
</html>
