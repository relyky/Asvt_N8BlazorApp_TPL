@*
* æ±ºç­–æ¨¹ç·¨è¼¯å™¨ - Decision Tree Editor 
*@

@using Microsoft.AspNetCore.Components.Forms

<div class="dt-container">
    <!-- å·¦å´ Tree View -->
    <div class="dt-tree-panel">
        <div class="dt-tree-header">
            @TreeHeaderContent        
        </div>
        <InputFile OnChange="ImportFromJSON" accept=".json" style="display: none;" id="fileInput" />
        <div class="dt-tree-content">
            @if (Root.Children.Count == 0)
            {
                <div class="dt-placeholder">
                    <p>å°šç„¡ç¯€é»ï¼Œè«‹é»æ“Šã€Œæ–°å¢æ ¹ç¯€é»ã€é–‹å§‹å»ºç«‹æ±ºç­–æ¨¹</p>
                </div>
            }
            else
            {
                @foreach (var child in Root.Children)
                {
                    <TreeNodeWidget Node="child"
                                    Parent="Root"
                                    SelectedNode="SelectedNode"
                                    OnSelectNode="SelectNode"
                                    OnToggleNode="ToggleNode"
                                    GetNodeLabel="GetNodeLabel"
                                    GetNodeIcon="GetNodeIcon"
                                    GetNodeClass="GetNodeClass"
                                    GetNodeTypeName="GetNodeTypeName"
                                    HasAssignmentError="HasAssignmentError" />
                }
            }
        </div>
    </div>

    <!-- å³å´ç·¨è¼¯å€ -->
    <div class="dt-edit-panel">
        <div class="dt-edit-header">
            <h2>âœï¸ ç¯€é»ç·¨è¼¯å™¨</h2>
        </div>
        <div class="dt-edit-content">
            @if (_showValidation)
            {
                <div>
                    @if (_validationErrors.Count == 0 && _validationWarnings.Count == 0)
                    {
                        <div class="dt-validation-success">âœ“ æ±ºç­–æ¨¹çµæ§‹é©—è­‰é€šéï¼</div>
                    }

                    @if (_validationErrors.Count > 0)
                    {
                        <div class="dt-validation-error">
                            <strong>âŒ ç™¼ç¾éŒ¯èª¤:</strong>
                            <ul>
                                @foreach (var err in _validationErrors)
                                {
                                    <li>@err</li>
                                }
                            </ul>
                        </div>
                    }

                    @if (_validationWarnings.Count > 0)
                    {
                        <div class="dt-validation-warning">
                            <strong>âš ï¸ è­¦å‘Šè¨Šæ¯:</strong>
                            <ul>
                                @foreach (var warn in _validationWarnings)
                                {
                                    <li>@warn</li>
                                }
                            </ul>
                        </div>
                    }

                    <div class="dt-button-group">
                        <button class="dt-btn dt-btn-primary" @onclick="CloseValidation">è¿”å›ç·¨è¼¯</button>
                    </div>
                </div>
            }
            else if (SelectedNode == null)
            {
                <div class="dt-placeholder">
                    <p>è«‹å¾å·¦å´é¸æ“‡ä¸€å€‹ç¯€é»é€²è¡Œç·¨è¼¯</p>
                </div>
            }
            else
            {
                @RenderEditPanel(SelectedNode)
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public required RenderFragment TreeHeaderContent { get; set; }

    private RenderFragment RenderEditPanel(TreeNode node) => __builder =>
    {
        var parent = FindParentNode(Root, node.Id);
        var hasAssignmentError = HasAssignmentError(node);
        var operators = new[] { "=", "!=", ">", "<", ">=", "<=", "in" };

        @if (hasAssignmentError)
        {
            <div class="dt-validation-error">
                âš ï¸ <strong>çµæ§‹éŒ¯èª¤ï¼š</strong>Assignment æ˜¯çµ‚æ­¢é»ï¼Œä¸æ‡‰è©²æœ‰å­ç¯€é»ï¼ç›®å‰æœ‰ @node.Children.Count å€‹å­ç¯€é»ã€‚<br />
                è«‹åˆªé™¤æ‰€æœ‰å­ç¯€é»æˆ–èª¿æ•´çµæ§‹ã€‚
            </div>
        }

        <div class="dt-form-group">
            <label>ç¯€é»é¡å‹</label>
            <select @bind="node.Type" @bind:after="StateHasChanged">
                <option value="None">NONE (æœªæŒ‡å®š)</option>
                <option value="IfCondition">IF (æ¢ä»¶åˆ¤æ–·)</option>
                <option value="ElseBranch">ELSE (å…¶å®ƒåˆ†æ”¯)</option>
                <option value="Assignment">Assignment (æŒ‡å®šæ•¸å€¼)</option>
            </select>
        </div>

        <div class="dt-form-group">
            <label>èªªæ˜ (Description)</label>
            <input type="text" @bind="node.Description" @bind:after="StateHasChanged"
                   placeholder="æ­¤ç¯€é»çš„èªªæ˜æ–‡å­—..." />
        </div>

        @if (node.Type == "IfCondition")
        {
            <div id="conditionGroup">
                <fieldset style="border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                    <legend style="font-weight: bold; color: #2c3e50; padding: 0 5px;">æ¢ä»¶ (Condition)</legend>
                    <div style="margin-top: 5px;">
                        <div class="dt-form-group">
                            <label>æ¯”è¼ƒæ¬„ä½</label>
                            <input type="text" @bind="node.CondField" @bind:after="StateHasChanged"
                                   placeholder="ä¾‹å¦‚: age, score" />
                        </div>
                        <div class="dt-form-group">
                            <label>æ¯”è¼ƒé‹ç®—å­</label>
                            <select @bind="node.CondOp" @bind:after="StateHasChanged">
                                @foreach (var op in operators)
                                {
                                    <option value="@op">@op</option>
                                }
                            </select>
                        </div>
                        <div class="dt-form-group">
                            <label>æ¯”è¼ƒæ•¸å€¼</label>
                            <input type="text" @bind="node.CondValue" @bind:after="StateHasChanged"
                                   placeholder="ä¾‹å¦‚: 18, 'true', 'Admin'" />
                        </div>
                    </div>
                </fieldset>
            </div>
        }

        @if (node.Type == "Assignment")
        {
            <div class="dt-form-group">
                <label>æŒ‡å®šå€¼ (Assignment)</label>
                <textarea @bind="node.Assignment" @bind:after="StateHasChanged"
                          placeholder="ä¾‹å¦‚: '3A', 'Bar', result"></textarea>
            </div>
        }

        <div class="dt-button-group">
            <button class="dt-btn dt-btn-primary" @onclick="() => AddChildNode(node)">â• æ–°å¢å­ç¯€é»</button>
            @if (parent != null)
            {
                <button class="dt-btn dt-btn-primary" @onclick="() => AddSiblingNode(node)">â• æ–°å¢å…„å¼Ÿç¯€é»</button>
            }
        </div>
        <div class="dt-button-group">
            <button class="dt-btn dt-btn-danger" @onclick="() => DeleteNode(node)">ğŸ—‘ï¸ åˆªé™¤ç¯€é»</button>
        </div>

        <div class="dt-output-section">
            <h3>ç¯€é»è³‡è¨Š</h3>
            <div class="dt-form-group">
                <select @bind="_infoFormat" @bind:after="StateHasChanged">
                    <option value="text">åŸºæœ¬è³‡è¨Š</option>
                    <option value="json">JSON æ ¼å¼</option>
                </select>
            </div>
            @if (_infoFormat == "text")
            {
                <pre>ID: @node.Id
é¡å‹: @GetNodeTypeName(node.Type)
å­ç¯€é»æ•¸: @node.Children.Count
èªªæ˜: @(string.IsNullOrWhiteSpace(node.Description) ? "(ç„¡)" : node.Description)
@if (node.Type == "IfCondition")
{<text>æ¢ä»¶: @node.CondField @node.CondOp @node.CondValue</text>}
@if (node.Type == "Assignment" && !string.IsNullOrWhiteSpace(node.Assignment))
{<text>æŒ‡å®šå€¼: @node.Assignment</text>}</pre>
            }
            else
            {
                <pre>@System.Text.Json.JsonSerializer.Serialize(node.ToJSON(), new System.Text.Json.JsonSerializerOptions
                {
                    WriteIndented = true,
                    Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping
                })</pre>
            }
            <button class="dt-btn dt-btn-primary" style="width: 100%; margin-top: 10px;" @onclick="() => CopyNodeJSON(node)">
                ğŸ“‹ è¤‡è£½ç¯€é» JSON
            </button>
        </div>
    };

    private string _infoFormat = "text";

    private async Task CopyNodeJSON(TreeNode node)
    {
        var json = System.Text.Json.JsonSerializer.Serialize(node.ToJSON(), new System.Text.Json.JsonSerializerOptions
        {
            WriteIndented = true,
            Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping
        });

        if (_jsModule != null)
        {
            await _jsModule.InvokeVoidAsync("copyToClipboard", json);
        }
        await ShowNotificationAsync("âœ“ ç¯€é» JSON å·²è¤‡è£½ï¼", "success");
    }
}
