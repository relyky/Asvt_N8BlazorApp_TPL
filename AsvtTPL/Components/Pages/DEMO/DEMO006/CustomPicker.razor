@using Vista.Biz.DataPicking
@inherits AsvtFieldBase<string>
@inject ISnackbar snackSvc

<MudItem xs=@_xs sm=@_sm md=@_md lg=@_lg xl=@_xl xxl=@_xxl>
  <MudTextField T=string
                @bind-Value=@FieldValue
                For=@For
                Immediate=@Immediate
                Label=@_label
                ReadOnly=@_readOnly
                HelperText=@HelperText
                Required=@Required
                Class=@Class
                Variant=@(_readOnly ? Variant.Filled : Variant.Text)
                Adornment=Adornment.End
                AdornmentIcon=@Icons.Material.Filled.MenuBook
                OnAdornmentClick=ShowPicker />

  <MudPopover Open=@f_showPicker Class="pa-3" Paper
              OverflowBehavior=OverflowBehavior.FlipAlways
              AnchorOrigin=Origin.CenterCenter
              TransformOrigin=Origin.CenterCenter
              Style="min-width: 310px; max-width: 60vw;">

    <CustomTable SelectedItem=selectedItem
                      AcctId=@AcctId
                      SelectedItemChanged=SelectedItemChanged />
  </MudPopover>

  <MudOverlay Visible=@f_showPicker OnClick=@(() => f_showPicker = false) DarkBackground=false />

</MudItem>

@code {
  /// <summary>
  /// event:選取項目，用來拿取選取標的全部欄位。
  /// </summary>
  [Parameter] public EventCallback<CustomCodeInfo> OnItemClick { get; set; }

  /// <summary>
  /// 限制條件：客戶代碼 (此為 sample 依需要增減)
  /// </summary>
  [Parameter] public string? AcctId { get; set; }

  //## Resource

  //## State
  bool f_showPicker = false;
  CustomCodeInfo? selectedItem = null;

  async Task SelectedItemChanged(CustomCodeInfo item)
  {
    selectedItem = item;
    FieldValue = item.Code;
    await OnItemClick.InvokeAsync(item);
    f_showPicker = false;
  }

  async Task ShowPicker()
  {
    // 唯讀模式不可變更。
    if (_readOnly) return;

    // to render
    f_showPicker = true;
    await Task.CompletedTask;
  }
}
