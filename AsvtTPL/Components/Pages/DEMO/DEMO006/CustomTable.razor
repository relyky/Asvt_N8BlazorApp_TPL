@using Vista.Biz.DataPicking

<style>
  .selected {
    background-color: var(--mud-palette-info) !important;
  }

    .selected > td {
      color: white !important;
    }

      .selected > td .mud-input {
        color: white !important;
      }
</style>

<MudTable T="CustomCodeInfo" Items=itemList Hover Striped Dense Elevation=0
          Loading=@f_loading
          FixedHeader Height="calc(100vh - 400px)"
          RowClassFunc=SelectedRowClassFunc
          OnRowClick=HandleRowClick
          Filter=FilterFunc>
  <ToolBarContent>
    <MudText Typo=Typo.h6>@($"客戶({AcctId})聯絡人")</MudText>
    <MudSpacer />
    <MudTextField @bind-Value=@_filterString Placeholder="過濾:EName,CName" Class="mt-0"
                  Adornment=Adornment.Start AdornmentIcon=@Icons.Material.Outlined.FilterAlt />
  </ToolBarContent>
  <HeaderContent>
    <MudTh>Code</MudTh>
    <MudTh>Name</MudTh>
    <MudTh>AcctId</MudTh>
    <MudTh>Email</MudTh>
    <MudTh>Tel</MudTh>
    <MudTh>Fax</MudTh>
  </HeaderContent>
  <RowTemplate>
    <MudTd DataLabel="Code">@context.Code</MudTd>
    <MudTd DataLabel="Name">@context.Name</MudTd>
    <MudTd DataLabel="AcctId">@context.AcctId</MudTd>
    <MudTd DataLabel="Email">@context.Email</MudTd>
    <MudTd DataLabel="Tel">@context.Tel</MudTd>
    <MudTd DataLabel="Fax">@context.Fax</MudTd>
  </RowTemplate>
</MudTable>

@code {
  /// <summary>
  /// 限制條件：客戶代碼
  /// </summary>
  [Parameter, EditorRequired] public required string AcctId { get; set; }

  [Parameter, EditorRequired] public CustomCodeInfo? SelectedItem { get; set; }
  [Parameter, EditorRequired] public EventCallback<CustomCodeInfo> SelectedItemChanged { get; set; }

  //## Resource
  CustomCodeSeeker customSeeker = new();

  //## State
  bool f_loading = false;
  string _filterString = string.Empty;
  List<CustomCodeInfo> itemList = [];

  protected override async Task OnInitializedAsync()
  {
    f_loading = true;
    itemList = await customSeeker.LoadAsync(AcctId);
    f_loading = false;
  }

  Task HandleRowClick(TableRowClickEventArgs<CustomCodeInfo> e)
  {
    SelectedItemChanged.InvokeAsync(e.Item);
    return Task.CompletedTask;
  }

  bool FilterFunc(CustomCodeInfo item)
  {
    if (string.IsNullOrEmpty(_filterString))
      return true;

    // 過濾條件
    return (item.Code != null && item.Code.Contains(_filterString, StringComparison.OrdinalIgnoreCase)) ||
          (item.Name != null && item.Name.Contains(_filterString, StringComparison.OrdinalIgnoreCase));
  }

  string SelectedRowClassFunc(CustomCodeInfo item, int rowNumber)
  {
    return (SelectedItem != null && SelectedItem.Code == item.Code) ? "selected" : string.Empty;
  }
}
