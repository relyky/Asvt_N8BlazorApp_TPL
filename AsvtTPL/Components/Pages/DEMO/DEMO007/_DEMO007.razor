@using BlazorTemplater
@using Vista.Biz.DEMO
@using Vista.Component.Models
@page "/DEMO007"
@attribute [Page("DEMO007", "各項機制測試")]
@attribute [Authorize("AuthPage")]
@inject IDialogServiceEx dlgSvc
@inject ISnackbar snackSvc
@inject SampleBiz bizSvc
@inject JSInterOpService jsTool
@inject IJSRuntime jsr
@inject NavigationManager navSvc

<MudContainer>
  <MudText Typo=Typo.h3 GutterBottom>各項機制測試</MudText>

  @* 命令列 *@
  <MudStack Row Justify=Justify.Center Class="mb-2">
    <MudButton Variant=Variant.Filled Color=Color.Primary OnClick=HandleComponentRendererReport>測試 Render Component to Report</MudButton>
    <MudButton Variant=Variant.Filled OnClick=HandleHtmlReport>測試 Html Report</MudButton>
    <MudButton Variant=Variant.Filled OnClick=HandlePdfReport>測試 Html to PDF</MudButton>
    <MudButton Variant=Variant.Filled OnClick=HandlePrintPdf>測試直接送印 PDF</MudButton>
  </MudStack>
  <MudStack Row Justify=Justify.Center Class="mb-2">
    <MudButton Variant=Variant.Filled Color=Color.Secondary OnClick=HandleAnzFdlTestReport>測試 FDL report</MudButton>
    <MudButton Variant=Variant.Filled Color=Color.Secondary OnClick=HandleLandscapeReport>測試橫印、header、footer</MudButton>
  </MudStack>

  @if (f_loading)
  {
    <MudProgressLinear Color=Color.Info Indeterminate Class="my-2" />
  }

  <MudDivider Class="my-4" />

  @* 命令列 *@
  <MudStack Row Justify=Justify.Center Class="mb-2">
    <LoadingButton Label="測試 Snackbar" OnClick=HandleShowSnackbar />
    <LoadingButton Label="模擬長程運算過程中送 NotifyMessage" OnClick=HandlePostSnack2 />
  </MudStack>
  <NotifyMessageResp />

  <MudStack Row Justify=Justify.Center Class="mb-2">
    <MudButton Variant=Variant.Filled OnClick=@(()=> dlgSvc.ShowAlert("預設為失敗訊息。"))>
      測試 ShowAlert
    </MudButton>
    <MudButton Variant=Variant.Filled OnClick=@(()=> dlgSvc.ShowAlert("我出運了。", Color.Success))>
      測試 ShowAlert 成功
    </MudButton>
    <MudButton Variant=Variant.Filled OnClick=@(()=> {
               var longMessag = new System.Text.StringBuilder("聞官軍收河南河北 杜甫\r\n");
               longMessag.AppendLine("劍外忽傳收薊北，初聞涕淚滿衣裳。卻看妻子愁何在？漫捲詩書喜欲狂。白日放歌須縱酒，青春作伴好還鄉。即從巴峽穿巫峽，便下襄陽向洛陽。");
               longMessag.AppendLine("黃鶴樓 崔顥");
               longMessag.AppendLine("昔人已乘黃鶴去，此地空餘黃鶴樓。黃鶴一去不復返，白雲千載空悠悠。晴川歷歷漢陽樹，芳草萋萋鸚鵡洲。日暮鄉關何處是？煙波江上使人愁。");
               dlgSvc.ShowAlert(longMessag.ToString(), Color.Info, "測試多行訊息");
               })>
      測試 ShowAlert 長訊息
    </MudButton>
  </MudStack>

  <MudStack Row Justify=Justify.Center Class="mb-2">
    <MudButton Variant=Variant.Filled OnClick=HandleConfirm>測試 ConfirmAsync</MudButton>
    <MudButton Variant=Variant.Filled OnClick=HandleConfirm2>測試 ConfirmAsync2</MudButton>
  </MudStack>

  <TestErrorBoundary />

  <TestRowVersion />

  <MudPaper Class="my-3 pa-3">
    <MudMenu Label="相關功能" Variant=Variant.Filled Color=Color.Secondary EndIcon=@Icons.Material.Filled.KeyboardArrowDown>
      <MudMenuItem Href="DEMO002" Target="_blank">DEMO002</MudMenuItem>
      <MudMenuItem Href="DEMO003" Target="_blank">DEMO003</MudMenuItem>
      <MudMenuItem Href="DEMO004" Target="_blank">DEMO004</MudMenuItem>
      <MudMenuItem Href=@($"DEMO009/聖麟") Target="_blank">DEMO009</MudMenuItem>
    </MudMenu>
  </MudPaper>

</MudContainer>

@code {
  //## State
  bool f_loading = false;

  async Task HandleConfirm()
  {
    bool confirmed = await dlgSvc.ConfirmAsync("再確定要刪除？");
    if (confirmed)
    {
      dlgSvc.ShowAlert("將執行刪除。", Color.Info);
    }
  }

  async Task HandleConfirm2()
  {
    bool confirmed = await dlgSvc.ConfirmAsync("再確定要執行刪除無法反悔？", Color.Error, "無法反悔的決定");
    if (confirmed)
    {
      dlgSvc.ShowAlert("將執行刪除無法反悔。", Color.Info);
    }
    else
    {
      dlgSvc.ShowAlert("這事當作沒發生。", Color.Default);
    }
  }

  async Task HandleShowSnackbar()
  {
    // 以 toast/snackbar 呈現訊息
    snackSvc.Add($"測試 Snackbar 訊息 at {DateTime.Now:HH:mm:ss}");
    await Task.Delay(Random.Shared.Next(200, 1000));

    snackSvc.Add($"測試 Snackbar Warning 訊息 at {DateTime.Now:HH:mm:ss}", Severity.Warning);
    await Task.Delay(Random.Shared.Next(200, 1000));

    snackSvc.Add($"測試 Snackbar Error 訊息 at {DateTime.Now:HH:mm:ss}", Severity.Error);
    await Task.Delay(Random.Shared.Next(200, 1000));

    snackSvc.Add($"測試 Snackbar Success 訊息 at {DateTime.Now:HH:mm:ss}", Severity.Success);
    await Task.Delay(Random.Shared.Next(200, 1000));

    snackSvc.Add($"測試 Snackbar Info 訊息 at {DateTime.Now:HH:mm:ss}", Severity.Info);
    await Task.Delay(Random.Shared.Next(200, 1000));
  }

  async Task HandlePostSnack2()
  {
    await Task.Run(() => bizSvc.SimsLongtermProcedure(new QryForecastArgs()));
  }

  async Task HandleHtmlReport()
  {
    try
    {
      f_loading = true;

      //# 產生 HTML 報表檔
      byte[] fileBlob = await Task.Run(() => bizSvc.MakeHtmlReport());

      //# 下載檔案
      string filename = $"ReportSample_{DateTime.Now.ToString("yyyyMMdd")}.html";
      await jsTool.DownloadFileAsync(filename, fileBlob);
    }
    catch (Exception ex)
    {
      dlgSvc.ShowAlert("出現例外！" + ex.Message);
    }
    finally
    {
      f_loading = false;
    }
  }

  async Task HandlePdfReport()
  {
    try
    {
      f_loading = true;

      //# 產生 PDF 報表檔
      byte[] fileBlob = await Task.Run(() => bizSvc.MakePdfReport());
      //# 下載檔案
      string filename = $"ReportSample_{DateTime.Now.ToString("yyyyMMdd")}.pdf";
      await jsTool.DownloadFileAsync(filename, fileBlob);
    }
    catch (Exception ex)
    {
      dlgSvc.ShowAlert("出現例外！" + ex.Message);
    }
    finally
    {
      f_loading = false;
    }
  }

  async Task HandlePrintPdf()
  {
    try
    {
      f_loading = true;

      //# 產生 PDF 報表檔
      byte[] fileBlob = await Task.Run(() => bizSvc.MakePdfReport());
      //# 直接送印 PDF
      await DoPrintPdfAsync(fileBlob);
    }
    catch (Exception ex)
    {
      dlgSvc.ShowAlert("出現例外！" + ex.Message);
    }
    finally
    {
      f_loading = false;
    }
  }

  /// <summary>
  /// helper: 直接送印 PDF 檔
  /// ※ 請先安裝好 print-js 函式庫。
  /// </summary>
  async Task DoPrintPdfAsync(byte[] pdfBlob)
  {
    string base64 = Convert.ToBase64String(pdfBlob);
    await jsr.InvokeVoidAsync("printJS", new
    {
      printable = base64,
      type = "pdf",
      base64 = true
    });
  }

  async Task HandleComponentRendererReport()
  {
    try
    {
      f_loading = true;

      // 模擬資料
      List<ImageCropInfo> itemList = new()
      {
        new ImageCropInfo { ImageFileName = "image1.jpg", ImageType = "JPEG" },
        new ImageCropInfo { ImageFileName = "image2.png", ImageType = "PNG" },
        new ImageCropInfo { ImageFileName = "image3.gif", ImageType = "GIF" },
      };

      List<(string, string)> barcodeList = new()
      {
        ("A10011", "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADoAAAA6AQMAAADbddhrAAAABlBMVEWNFIX///9IEO+QAAAAi0lEQVR4nK3RMQoEIQwF0EBawasIaQdydcHWwwi/Xci4GmWcdtfqwSf6g2TzZPoVxDWRPqHIsANJgvALFW9gRQ6Fid/jIJb1lsMsqPdxMFHBgR6iHmhSdIxvSI8+BwqbXAfMUh3jG8RXbrOPQ0EhfqONvnKG775gaDPaENUZORQRo/wGcezhE//5wRuPCTh2Hi4G9AAAAABJRU5ErkJggg=="),
        ("B10011", "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADoAAAA6AQMAAADbddhrAAAABlBMVEWNFIX///9IEO+QAAAAi0lEQVR4nK3RMQoEIQwF0EBawasIaQdydcHWwwi/Xci4GmWcdtfqwSf6g2TzZPoVxDWRPqHIsANJgvALFW9gRQ6Fid/jIJb1lsMsqPdxMFHBgR6iHmhSdIxvSI8+BwqbXAfMUh3jG8RXbrOPQ0EhfqONvnKG775gaDPaENUZORQRo/wGcezhE//5wRuPCTh2Hi4G9AAAAABJRU5ErkJggg=="),
        ("C10011", "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADoAAAA6AQMAAADbddhrAAAABlBMVEWNFIX///9IEO+QAAAAi0lEQVR4nK3RMQoEIQwF0EBawasIaQdydcHWwwi/Xci4GmWcdtfqwSf6g2TzZPoVxDWRPqHIsANJgvALFW9gRQ6Fid/jIJb1lsMsqPdxMFHBgR6iHmhSdIxvSI8+BwqbXAfMUh3jG8RXbrOPQ0EhfqONvnKG775gaDPaENUZORQRo/wGcezhE//5wRuPCTh2Hi4G9AAAAABJRU5ErkJggg=="),
        ("D10011", "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADoAAAA6AQMAAADbddhrAAAABlBMVEWNFIX///9IEO+QAAAAi0lEQVR4nK3RMQoEIQwF0EBawasIaQdydcHWwwi/Xci4GmWcdtfqwSf6g2TzZPoVxDWRPqHIsANJgvALFW9gRQ6Fid/jIJb1lsMsqPdxMFHBgR6iHmhSdIxvSI8+BwqbXAfMUh3jG8RXbrOPQ0EhfqONvnKG775gaDPaENUZORQRo/wGcezhE//5wRuPCTh2Hi4G9AAAAABJRU5ErkJggg=="),
        ("A19002", "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADoAAAA6AQMAAADbddhrAAAABlBMVEWNFIX///9IEO+QAAAAjklEQVR4nK3RQQrEMAgFUMFtoVcR3Ba8eqBbDxP4B3AaNGHS7UxWD34wfkKRp9GvIHYh+4ahITaIHsovON7AjAqG0JpTINb5ViHisNqnwEQ3dnjAx+WF3tVkRAviXKtO3MqqI1qIIPcNxNJ67lMwXMc5ogXRqyF7LQA9o4XTLKOC4clyTuGprFrdE//5wQ+PIDbYpkeIRwAAAABJRU5ErkJggg=="),
      };

      //# 產生 HTML 報表檔
      string html = new ComponentRenderer<MyHtmlReport>()
                          .Set(m => m.Title, "唷~ 太神了傑克")
                          .Set(m => m.ItemList, itemList)
                          .Set(m => m.BarcodeList, barcodeList)
                          .Set(m => m.WatermarkImageUrl, $"{navSvc.BaseUri}image/watermark_draft.png")
                          .Render();

      // Convert to blob
      //byte[] fileBlob = System.Text.UTF8Encoding.UTF8.GetBytes(html); // html file blob.
      byte[] fileBlob = await Task.Run(() => bizSvc.HtmlToPdf(html)); // pdf file blob.

      //# 下載檔案
      string filename = $"ReportSample_{DateTime.Now.ToString("yyyyMMdd")}.pdf";
      await jsTool.DownloadFileAsync(filename, fileBlob);
    }
    catch (Exception ex)
    {
      dlgSvc.ShowAlert("出現例外！" + ex.Message);
    }
    finally
    {
      f_loading = false;
    }
  }

  async Task HandleAnzFdlTestReport()
  {
    try
    {
      f_loading = true;

      //# 產生 HTML 報表檔
      string html = await Task.Run(() => bizSvc.MakeAnzFdlTestHtml());

      // Convert to blob
      //byte[] fileBlob = System.Text.UTF8Encoding.UTF8.GetBytes(html); // html file blob.
      byte[] fileBlob = await Task.Run(() => bizSvc.HtmlToPdf_NoFooter(html)); // pdf file blob.

      //# 下載檔案
      string filename = $"AnzFdlTestReport_{DateTime.Now.ToString("yyyyMMdd")}.pdf";
      await jsTool.DownloadFileAsync(filename, fileBlob);
    }
    catch (Exception ex)
    {
      dlgSvc.ShowAlert("出現例外！" + ex.Message);
    }
    finally
    {
      f_loading = false;
    }
  }

  async Task HandleLandscapeReport()
  {
    try
    {
      f_loading = true;

      //# 產生 HTML 報表檔
      string html = await Task.Run(() => bizSvc.MakeLandscapeHtml());

      // Convert to blob
      string fileType = true ? "pdf" : "html";
      byte[] fileBlob = fileType == "html"
        ? System.Text.UTF8Encoding.UTF8.GetBytes(html) // html file blob.
        : await Task.Run(() => bizSvc.HtmlToPdf_Landscape(html)); // pdf file blob.

      //# 下載檔案
      string filename = $"LandscapeReport_{DateTime.Now.ToString("yyyyMMdd")}.{fileType}";
      await jsTool.DownloadFileAsync(filename, fileBlob);
    }
    catch (Exception ex)
    {
      dlgSvc.ShowAlert("出現例外！" + ex.Message);
    }
    finally
    {
      f_loading = false;
    }

  }

}
