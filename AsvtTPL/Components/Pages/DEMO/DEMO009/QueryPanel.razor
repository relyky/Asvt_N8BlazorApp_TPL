@using Vista.Biz.DEMO
@inject IDialogServiceEx dlgSvc
@inject DEMO009Biz bizSvc

<MudPaper role="panel">
  <EditForm Model=@qryArgs>
    <FluentValidator Validator=argsValidator AsyncMode />
    <AsvtFormRow>
      <AsvtTextField For="()=>qryArgs.Arg1" HelperText="用大寫'Ａ'為查詢參數" />
      <AsvtTextField For="()=>qryArgs.Arg2" />
    </AsvtFormRow>
    <MudStack Row Justify=Justify.Center Class="my-1">
      <MudButton Variant=Variant.Filled Color=Color.Primary OnClick="() => HandleQuery(context)">查詢</MudButton>
      <MudButton Variant=Variant.Outlined Color=Color.Primary OnClick=HandleReset>重置</MudButton>
    </MudStack>
    <DialogValidationSummary />
  </EditForm>
</MudPaper>

@if (f_loading)
{
  <MudProgressLinear Color=Color.Info Indeterminate Class="my-3" />
}

@code {
  [Parameter] public string? QArg1 { get; set; }
  [Parameter] public EventCallback<List<DEMO009Data>> OnRetrieveDataList { get; set; }

  //## Resource
  DEMO009QryArgsValidator argsValidator = new();

  //## State
  bool f_loading = false;
  DEMO009QryArgs qryArgs = new();

  protected override async Task OnInitializedAsync()
  {
    if (QArg1 != null)
    {
      qryArgs = qryArgs with { Arg1 = QArg1 };
      EditContext ctx = new EditContext(qryArgs);
      await HandleQuery(ctx);
    }
  }

  /// <summary>
  /// 執行查詢
  /// </summary>
  async Task HandleQuery(EditContext ctx)
  {
    try
    {
      //# 查詢條件檢查
      bool validated = await ctx.ValidateAsync();
      if (!validated)
      {
        // 未通過基本表單驗證！將觸發 CustomValidationSummary。
        return;
      }

      //# GO
      f_loading = true;

      //# 資料演算
      var dataList = await Task.Run(() => bizSvc.QryDataList(qryArgs));

      // success
      await OnRetrieveDataList.InvokeAsync(dataList);
    }
    catch (Exception ex)
    {
      dlgSvc.ShowAlert(ex.Message, title: "出現例外");
    }
    finally
    {
      f_loading = false;
    }
  }

  /// <summary>
  /// 重置查詢條件
  /// </summary>
  void HandleReset()
  {
    qryArgs = new DEMO009QryArgs() with { Arg1 = QArg1 };
  }
}
