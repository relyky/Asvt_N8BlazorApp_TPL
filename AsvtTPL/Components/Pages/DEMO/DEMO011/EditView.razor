@using Vista.Biz.DEMO
@inject IDialogServiceEx dlgSvc
@inject DEMO011Biz bizSvc

@if (formData is null)
{
  <MudProgressCircular Indeterminate Color=Color.Info />
  return;
}

<ScreenOverlay Visible=f_loading />
<EditForm Model=formData>
  <FluentValidationValidator />

  <MudPaper role="panel">
    <AsvtFormRow Grid=@([12,6])>
      <AsvtTextField For="()=>formData.formNo" ReadOnly=true />
      <AsvtTextField For="()=>formData.dataFieldA" />
      <AsvtTextField For="()=>formData.dataFieldB" />
      <AsvtTextField For="()=>formData.dataFieldC" />
    </AsvtFormRow>
    <MudStack Row Justify=Justify.Center Class="my-3">
      <MudButton Variant=Variant.Filled Color=Color.Primary OnClick="()=>HandleSubmit(context)">存檔</MudButton>
      <MudButton Variant=Variant.Outlined Color=Color.Warning OnClick=HandleRemove>刪除</MudButton>
    </MudStack>
  </MudPaper>

  <DialogValidationSummary />
</EditForm>

@code {
  [CascadingParameter] _DEMO011 BizState { get; init; } = default!;

  //## State
  DEMO011FormData? formData = null;
  bool f_loading = false;

  protected override void OnParametersSet()
  {
    formData = BizState.dataAim != null
      ? BizState.dataAim.Clone()
      : null;
  }

  async Task HandleSubmit(EditContext context)
  {
    try
    {
      //# 基本檢查
      if (!context.Validate()) return;

      //# block UI
      f_loading = true;

      //# 資料演算
      if (formData is null) return;
      (formData, string message) = await Task.Run(() => bizSvc.UpdFormData(formData));
      if (message != "SUCCESS")
      {
        dlgSvc.ShowAlert(message);
        return;
      }

      //# 成功後同步UI資料 & 刷新畫面
      var idx = BizState.dataList.FindIndex(c => c.formNo == formData.formNo);
      BizState.dataList[idx] = formData;
      BizState.dataAim = formData;
      BizState.NotifyStateChanged();
      dlgSvc.ShowAlert("更新完成。", Color.Success);
    }
    catch (Exception ex)
    {
      dlgSvc.ShowAlert(ex.Message, title: "出現例外！");
    }
    finally
    {
      f_loading = false;
    }
  }

  async Task HandleRemove()
  {
    try
    {
      //# 再確定一次
      bool isConfirm = await dlgSvc.ConfirmAsync($"再確定一次要刪除這筆資料？");
      if (!isConfirm) return;

      //# block UI
      f_loading = true;

      //# 資料演算
      var aim = BizState.dataAim;
      if (aim is null) return;
      await Task.Run(() => bizSvc.DelFormData(aim));

      //# 成功後同步UI資料 & 刷新畫面
      BizState.dataList.RemoveAll(c => c.formNo == aim.formNo);
      BizState.dataAim = null;
      BizState.NotifyStateChanged();
      dlgSvc.ShowAlert("刪除完成。", Color.Success);
    }
    catch (Exception ex)
    {
      dlgSvc.ShowAlert(ex.Message, title: "出現例外！");
    }
    finally
    {
      f_loading = false;
    }
  }
}
