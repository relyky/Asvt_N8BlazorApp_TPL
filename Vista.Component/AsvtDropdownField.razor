@using MudBlazor.Utilities
@inherits AsvtFieldBase<string>

@* 解決 MudAutocomplete 在 ReadOnly 狀態下仍可下拉的 bug。 *@　
<style>
  .asvt-dropdown-field-no-pointer-events {
  pointer-events: none;
  }
</style>

@* 建議未來改名成：AsvtComboboxField。命名依照 Material Design 典範 *@
@* ※ 屬性 SelectValueOnTab 若設成 true 會讓下一個 select 元件掉入無限遞迴！ *@
@* 例如：選『銀行』→ <tab> →『分行』會進入 UI 無限遞迴。 *@
<MudItem xs=@_xs sm=@_sm md=@_md lg=@_lg xl=@_xl xxl=@_xxl>
  <MudAutocomplete T="ICodeName"
  @bind-Value=codeValue
  Immediate=@Immediate
  Label=@_label
  ReadOnly=@_readOnly
  HelperText=@HelperText
  Required=@Required
  Class=@CssClass
  Variant=@(_readOnly ? Variant.Filled : Variant.Text)
  Error=@ValidationError
  ErrorText=@ValidationErrorText
  SearchFunc=@CodeRepo.SearchFunc
  ToStringFunc=@ToStringFunc
  MaxItems=@MaxItems
  MaxHeight="500"
  OpenIcon=@Icons.Material.Filled.ExpandMore
  CloseIcon=@Icons.Material.Filled.ExpandLess
  DebounceInterval=300
  Clearable=true
  ResetValueOnEmptyText=true
  CoerceValue=false
  CoerceText=true
  Strict=true
  SelectValueOnTab=true
  SelectOnActivation=false
  OpenOnFocus=false
  ShowProgressIndicator=true
  ProgressIndicatorColor=Color.Info>
    <MoreItemsTemplate>
      <MudText Align=Align.Center Class="px-4 py-1 mud-theme-dark">
        @($"只顯示前{MaxItems}/{CodeRepo.CodeList.Count}筆")
      </MudText>
    </MoreItemsTemplate>
  </MudAutocomplete>
</MudItem>

@code {
  /// <summary>
  /// the CodeName Repository
  /// </summary>
  [Parameter, EditorRequired] public ICodeNameRepo CodeRepo { get; init; } = default!;

  /// <summary>
  /// 呈現下拉項目筆數。null 表示不限制。
  /// </summary>
  [Parameter] public int? MaxItems { get; set; } = 100;

  /// <summary>
  /// 代碼名稱轉換函數。
  /// </summary>
  [Parameter] public Func<ICodeName, string?> ToStringFunc { get; set; } = (c) => c == null ? null : $"{c.Code}-{c.Name}";

  //## 轉型 FieldValue
  ICodeName? codeValue
  {
    get => CodeRepo[FieldValue];
    set => FieldValue = (value != null) ? value.Code : null!;
  }

  string CssClass => new CssBuilder()
    .AddClass("asvt-dropdown-field-no-pointer-events", _readOnly)
    .Build();

  protected override void OnInitialized()
  {
    CodeRepo.LoadedAct = StateHasChanged;
  }
}