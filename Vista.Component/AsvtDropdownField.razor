@using MudBlazor.Utilities
@inherits AsvtFieldBase<string>

@* 解決 MudAutocomplete 在 ReadOnly 狀態下仍可下拉的 bug。 *@　
<style>
  .asvt-dropdown-field-no-pointer-events {
    pointer-events: none;
  }
</style>

@* 建議未來改名成：AsvtComboboxField。命名依照 Material Design 典範 *@
@* ※ 屬性 SelectValueOnTab 若設成 true 會讓下一個 select 元件掉入無限遞迴！ *@
@* 例如：選『銀行』→ <tab> →『分行』會進入 UI 無限遞迴。 *@
<MudItem xs=@_xs sm=@_sm md=@_md lg=@_lg xl=@_xl xxl=@_xxl>
  <MudAutocomplete T="ICodeName" @ref=refElement
                   @bind-Value=codeValue
                   Immediate=@Immediate
                   Label=@_label
                   ReadOnly=@_readOnly
                   HelperText=@HelperText
                   Required=@Required
                   Class=@CssClass
                   Variant=@(_readOnly ? Variant.Filled : Variant.Text)
                   Error=@ValidationError
                   ErrorText=@ValidationErrorText
                   SearchFunc=@CodeRepo.SearchFunc
                   ToStringFunc=@(c => c == null ? null : $"{c.Code}-{c.Name}")
                   MaxItems=@MaxItems
                   MaxHeight="500"
                   OpenIcon=@Icons.Material.Filled.ExpandMore
                   CloseIcon=@Icons.Material.Filled.ExpandLess
                   Clearable=true
                   ResetValueOnEmptyText=true
                   CoerceValue=false
                   CoerceText=true
                   SelectValueOnTab=false
                   Strict=true
                   ShowProgressIndicator=true
                   ProgressIndicatorColor=Color.Info>
    <MoreItemsTemplate>
      <MudText Align=Align.Center Class="px-4 py-1 mud-theme-dark">
        @($"只顯示前{MaxItems}/{CodeRepo.CodeList.Count}筆")
      </MudText>
    </MoreItemsTemplate>
  </MudAutocomplete>

  @if (!CodeRepo.IsLoaded)
  {
    @* 延遲載入中時，以 Skeleton 呈現。 *@
    <MudSkeleton Animation=MudBlazor.Animation.Pulse Width="40%" />
    <MudSkeleton Animation=MudBlazor.Animation.Wave Width="80%" Height="32px" />
  }
</MudItem>

@code {
  /// <summary>
  /// the CodeName Repository
  /// </summary>
  [Parameter, EditorRequired] public ICodeNameRepo CodeRepo { get; init; } = default!;

  /// <summary>
  /// 呈現下拉項目筆數。null 表示不限制。
  /// </summary>
  [Parameter] public int? MaxItems { get; set; } = 100;

  //## 轉型 FieldValue
  ICodeName? codeValue
  {
    get => CodeRepo[FieldValue];
    set => FieldValue = (value != null) ? value.Code : null!;
  }

  MudAutocomplete<ICodeName> refElement = default!;

  string CssClass => new CssBuilder()
    .AddClass(CodeRepo.IsLoaded ? Class : "d-none")
    .AddClass("asvt-dropdown-field-no-pointer-events", _readOnly)
    .Build();

  protected override void OnInitialized()
  {
    base.OnInitialized();
    CodeRepo.LoadedAct = () =>
    {
      //# Refersh
      refElement.SearchFunc(null, new CancellationToken()); // [非正確解]效果同初次填滿下拉項目。否則重置(填值)無作用！
      refElement.ForceRender(false);
      //codeValue = CodeNameRepo[FieldValue]; // 重新填入
      StateHasChanged();
    };
  }
}