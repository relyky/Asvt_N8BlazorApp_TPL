@using MudBlazor.Services
@implements IBrowserViewportObserver // 監聽螢幕變化介面
@implements IAsyncDisposable
@inject IBrowserViewportService viewSvc

<CascadingValue Value=@rowOption Name="AsvtFormRowOption">
  <MudGrid Class=@Class Spacing=@_spacing>
    @ChildContent
  </MudGrid>
</CascadingValue>

@code {
  [Parameter, EditorRequired] public RenderFragment ChildContent { get; set; } = default!;

  /// <summary>
  /// RWD Grid Cell 屬性：預設四欄。[12, 6, 4, 3]。
  /// 依 xs,sm,md,lg 指定數值
  /// </summary>
  [Parameter] public int[] Grid { get; set; } = [12, 6, 4, 3];
  [Parameter] public bool ReadOnly { get; set; } = false;
  [Parameter] public string? Class { get; set; }

  /// <summary>
  /// 各 Item 間的間隔距離。改成自動依寬度縮放。
  /// </summary>
  int _spacing = 3;

  AsvtFormRowOption rowOption => new()
    {
      Grid = this.Grid,
      ReadOnly = this.ReadOnly
    };

  public async ValueTask DisposeAsync() => await viewSvc.UnsubscribeAsync(this);
  Guid IBrowserViewportObserver.Id { get; } = Guid.NewGuid();
  ResizeOptions IBrowserViewportObserver.ResizeOptions => new() { ReportRate = 250, NotifyOnBreakpointOnly = true };

  /// <summary>
  /// 監聽訊息：螢幕大小變更
  /// </summary>
  Task IBrowserViewportObserver.NotifyBrowserViewportChangeAsync(BrowserViewportEventArgs e)
  {
    int newSpacing = e.Breakpoint switch
    {
      Breakpoint.Xs => 1,
      Breakpoint.Sm => 2,
      _ => 3
    };

    if (_spacing != newSpacing)
    {
      _spacing = newSpacing;
      return InvokeAsync(StateHasChanged);
    }
    else
    {
      return Task.CompletedTask;
    }
  }

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    // 註冊監聽訊息：螢幕大小變更
    if (firstRender)
      await viewSvc.SubscribeAsync(this, fireImmediately: true);
  }
}
