@inherits AsvtFieldBase<string>
@* 輸入西元年月：格式只能是10碼文字『YYYY/MM/DD』或8碼文字『YYYYMMDD』。
 * MudDatePicker 內附的 Mask 在 Server App 會太慢，改用 Cleave.js 實現 Mask 能力。
*@

<MudItem xs=@_xs sm=@_sm md=@_md lg=@_lg xl=@_xl xxl=@_xxl>
  <MudCleaveDateField @bind-Date=@dateValue
                      ImmediateText=@Immediate
                      Label=@_label
                      ReadOnly=@_readOnly
                      HelperText=@HelperText
                      Required=@Required
                      Class=@Class
                      Variant=@(_readOnly ? Variant.Filled : Variant.Text)
                      Error=@ValidationError
                      ErrorText=@ValidationErrorText
                      AnchorOrigin=@PickerOrigin
                      TransformOrigin=@PickerOrigin />
</MudItem>

@code {
  /// <summary>
  /// ref→[Menu Placement](https://mudblazor.com/components/menu#placement)
  /// </summary>
  [Parameter] public Origin PickerOrigin { get; set; } = Origin.TopLeft;

  /// <summary>
  /// 只支援 10碼"yyyy/MM/dd" 或 8碼"yyyyMMdd" 日期儲存格式。
  /// </summary>
  [Parameter] public string ValueFormat { get; set; } = "yyyyMMdd"; 

  ////## 替代 For。因為外部輸入型別與元件輸入型別對不上。
  // string errorText => String.Join(null, EditContext.GetValidationMessages(_fieldIdentifier));
  // bool f_Error => !String.IsNullOrEmpty(errorText);

  /// <summary>
  /// ※ 轉型 FieldValue
  /// </summary>
  DateTime? dateValue
  {
    get => DoParseDateTime(FieldValue, ValueFormat);
    set => FieldValue = value.HasValue ? value.Value.ToString(ValueFormat) : null;
  }

  /// <summary>
  /// helper, 範例：var dt = Utils.ParseDateTime("2021/02/03", "yyyy/MM/dd");
  /// </summary>
  private static DateTime? DoParseDateTime(string str, string fmt)
  {
    if (String.IsNullOrWhiteSpace(str))
      return null;

    DateTime dt;
    if (!DateTime.TryParseExact(str, fmt, null, System.Globalization.DateTimeStyles.None, out dt))
      return null;

    return new Nullable<DateTime>(dt);
  }
}